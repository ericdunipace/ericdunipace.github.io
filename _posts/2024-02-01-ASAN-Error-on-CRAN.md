---
  layout: post
title: ASAN Error on CRAN
description: >
  What to do about those increasingly obscure CRAN tests
  sitemap: false
---
  
Part of the joy of `R` is how easy it is to startup and begin data wrangling. While it may not be as known for  deployment or used in the computer science industry, it has a place in my heart for how easy it is to make pretty graphs. However, the package development process for CRAN, the largest repository, is [notoriously]() [honerous]() with increasingly [obscure tests]() that become required on an arbitrary basis. They are also know to be [not too pleasant about the whole thing.]()

This posts will walk through my process of replicating and varifying a new error/test on CRAN due to [ASAN](https://clang.llvm.org/docs/AddressSanitizer.html), or the Address Sanitizer function in Clang. This post is largely based on this [post](https://reside-ic.github.io/blog/debugging-and-fixing-crans-additional-checks-errors/) I found since obviously the CRAN team doesn't provide enough info to figure out where the error is coming from nor do they provide easy tools to do so!

## Heap use after free



```{r}
> library(testthat)
> library(WpProj)
> 
> testthat::skip_if_not_installed("stats")
> library(stats)
> 
> test_check("WpProj")
=================================================================
==3675911==ERROR: AddressSanitizer: heap-use-after-free on address 0x607000395b10 at pc 0x7f31603bfb15 bp 0x7fff299d9fb0 sp 0x7fff299d9fa8
READ of size 16 at 0x607000395b10 thread T0
    #0 0x7f31603bfb14 in double vector[2] Eigen::internal::pload<double vector[2]>(Eigen::internal::unpacket_traits<double vector[2]>::type const*) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/arch/SSE/PacketMath.h:307:112
    #1 0x7f31603bfb14 in double vector[2] Eigen::internal::ploadt<double vector[2], 16>(Eigen::internal::unpacket_traits<double vector[2]>::type const*) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/GenericPacketMath.h:460:12
    #2 0x7f31603bfb14 in double vector[2] Eigen::internal::evaluator<Eigen::PlainObjectBase<Eigen::Matrix<double, -1, 1, 0, -1, 1> > >::packet<16, double vector[2]>(long) const /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/CoreEvaluators.h:204:12
    #3 0x7f31603bfb14 in double vector[2] Eigen::internal::binary_evaluator<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const>, Eigen::internal::IndexBased, Eigen::internal::IndexBased, double, double>::packet<16, double vector[2]>(long) const /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/CoreEvaluators.h:734:50
    #4 0x7f31603bfb14 in void Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Matrix<double, -1, 1, 0, -1, 1> >, Eigen::internal::evaluator<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >, Eigen::internal::assign_op<double, double>, 0>::assignPacket<16, 16, double vector[2]>(long) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:658:87
    #5 0x7f31603bf57a in Eigen::internal::dense_assignment_loop<Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Matrix<double, -1, 1, 0, -1, 1> >, Eigen::internal::evaluator<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >, Eigen::internal::assign_op<double, double>, 0>, 3, 0>::run(Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Matrix<double, -1, 1, 0, -1, 1> >, Eigen::internal::evaluator<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >, Eigen::internal::assign_op<double, double>, 0>&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:416:23
    #6 0x7f31603bf57a in void Eigen::internal::call_dense_assignment_loop<Eigen::Matrix<double, -1, 1, 0, -1, 1>, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const>, Eigen::internal::assign_op<double, double> >(Eigen::Matrix<double, -1, 1, 0, -1, 1>&, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> const&, Eigen::internal::assign_op<double, double> const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:741:3
    #7 0x7f3160353b42 in Eigen::internal::Assignment<Eigen::Matrix<double, -1, 1, 0, -1, 1>, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const>, Eigen::internal::assign_op<double, double>, Eigen::internal::Dense2Dense, void>::run(Eigen::Matrix<double, -1, 1, 0, -1, 1>&, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> const&, Eigen::internal::assign_op<double, double> const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:879:5
    #8 0x7f3160353b42 in void Eigen::internal::call_assignment_no_alias<Eigen::Matrix<double, -1, 1, 0, -1, 1>, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const>, Eigen::internal::assign_op<double, double> >(Eigen::Matrix<double, -1, 1, 0, -1, 1>&, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> const&, Eigen::internal::assign_op<double, double> const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:836:3
    #9 0x7f3160353b42 in void Eigen::internal::call_assignment<Eigen::Matrix<double, -1, 1, 0, -1, 1>, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const>, Eigen::internal::assign_op<double, double> >(Eigen::Matrix<double, -1, 1, 0, -1, 1>&, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> const&, Eigen::internal::assign_op<double, double> const&, Eigen::internal::enable_if<!(evaluator_assume_aliasing<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >::value), void*>::type) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:804:3
    #10 0x7f3160353b42 in void Eigen::internal::call_assignment<Eigen::Matrix<double, -1, 1, 0, -1, 1>, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >(Eigen::Matrix<double, -1, 1, 0, -1, 1>&, Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/AssignEvaluator.h:782:3
    #11 0x7f3160353b42 in Eigen::Matrix<double, -1, 1, 0, -1, 1>& Eigen::PlainObjectBase<Eigen::Matrix<double, -1, 1, 0, -1, 1> >::_set<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >(Eigen::DenseBase<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> > const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/PlainObjectBase.h:714:7
    #12 0x7f3160353b42 in Eigen::Matrix<double, -1, 1, 0, -1, 1>& Eigen::Matrix<double, -1, 1, 0, -1, 1>::operator=<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> >(Eigen::DenseBase<Eigen::CwiseBinaryOp<Eigen::internal::scalar_quotient_op<double, double>, Eigen::Matrix<double, -1, 1, 0, -1, 1> const, Eigen::Matrix<double, -1, 1, 0, -1, 1> const> > const&) /data/gannet/ripley/R/test-clang/RcppEigen/include/Eigen/src/Core/Matrix.h:225:20
    #13 0x7f3160353b42 in oemXTX_gen::compute_lambda_zero(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) /data/gannet/ripley/R/packages/tests-clang-SAN/WpProj/src/oem_xtx.cpp:313:10
    #14 0x7f31602b88ad in W2penalized(SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*) /data/gannet/ripley/R/packages/tests-clang-SAN/WpProj/src/W2penalized.cpp:183:18
    #15 0x7f31602396ee in _WpProj_W2penalized /data/gannet/ripley/R/packages/tests-clang-SAN/WpProj/src/RcppExports.cpp:67:34
    ......
```
Unfortunately, this doesn't tell us which test is triggering the error so we can't find a bug!
